# TODO: make this composite a standalone action
name: Attack container CI
runs:
  using: composite
  steps:
    - name: ZAP Scan
      # FIXME: ZAP emits json or creates an issue only
      # possibly creatte an action
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        token: ${{ secrets.PAT }}
        # docker_name: ${{ env.TEST_TAG }}
        target: "http://localhost:8080/tomcat-webapp-boilerplate"
        # rules_file_name: ".zap/rules.tsv"
        cmd_options: "-a"
    # TODO: create custom action to convert zap json to sarif
    #
    # run custom container with nmap
    # TODO: add  self actions
    # FIXME: not working, broken action
    # inputs not passed correctly as flags
    # BUG: can't use docker action with scanners
    # docker actions don't pass the --network=host  flag
    # must create node action to run docker container
    # check zap action for reference
    # https://github.com/zaproxy/action-full-scan
    - name: Nmap Scan
      uses: gipo355/vuln-docker-scanners@v1.0.0
      with:
        target: "localhost"
        vulners: true
        port: "8080"
        generate-reports: true
    # init scanning for vulnerabilities
    - name: run snyk container
      run: snyk container test ${{ env.TEST_TAG }} --file=Dockerfile --sarif > snyk-container.sarif || true
    # - name: Run Snyk to check Docker image for vulnerabilities
    #   # Snyk can be used to break the build when it detects vulnerabilities.
    #   # In this case we want to upload the issues to GitHub Code Scanning
    #   continue-on-error: true
    #   uses: snyk/actions/docker@master
    #   # FIXME: sarif output doesn't work
    #   env:
    #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    #   with:
    #     image: ${{ env.TEST_TAG }}
    #     # sarif: true # default
    #     args: --file=Dockerfile
    #     # - name: Upload result to GitHub Code Scanning
    #     #   uses: github/codeql-action/upload-sarif@v3
    #     #   with:
    #     #     sarif_file: snyk.sarif
    # BUG: this sarif is broken for post-processing
    - name: display json output
      run: cat snyk-container.sarif
    - name: Upload snyk container result to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@f079b8493333aace61c81488f8bd40919487bd9f # v3
      with:
        sarif_file: snyk-container.sarif
#
# TODO: add load test, wapiti, and other scanners
#
# TODO: how to scan? on PR? on release?
#
# pen test and put comment in pr with the results now using PR image
# we will replicate the pen test with cron on another action on the dev branch tag released image
